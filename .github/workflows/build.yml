name: vmpbuild
on: [pull_request, push]
jobs:
  build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3
 
    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2
       
    - name: setup vsdevenv
      uses: seanmiddleditch/gha-setup-vsdevenv@master
 
    - name: Install Qt
      run: |
        pip install aqtinstall
        mkdir Qt
        cd Qt
        aqt install-qt windows desktop 5.12.12 win32_msvc2017
        aqt install-qt windows desktop 5.12.12 win64_msvc2017_64
         
    - name: build x64
      shell: cmd
      run: |
        set QTDIR=%GITHUB_WORKSPACE%\Qt\5.12.12\msvc2017_64
        set PATH=%PATH%;%GITHUB_WORKSPACE%\Qt\5.12.12\msvc2017_64\bin
        cmd.exe /c build-libffi.bat
        cmd.exe /c build-ultimate-x64.bat
        
    - name: Upload artifact64
      uses: actions/upload-artifact@v1
      with:
          name: vmp64
          path: vmprotect-3.5.1-build
          
    - name: build x86
      shell: cmd
      run: |
        set QTDIR=%GITHUB_WORKSPACE%\Qt\5.12.12\msvc2017
        set PATH=%PATH%;%GITHUB_WORKSPACE%\Qt\5.12.12\msvc2017\bin
        cmd.exe /c build-libffi.bat
        cmd.exe /c build-ultimate-x86.bat
 
    - name: Upload artifact32
      uses: actions/upload-artifact@v1
      with:
          name: vmp32
          path: vmprotect-3.5.1-build
